---
title: Финализаторы
content_type: concept
weight: 80
---

# Финализаторы

Финализаторы — это ключи в пространстве имен, которые сообщают Kubernetes дождаться выполнения определенных условий, прежде чем он полностью удалит ресурсы, помеченные для удаления. Финализаторы предупреждают контроллеры о необходимости очистить ресурсы, принадлежащие удаленному объекту.

Когда вы указываете Kubernetes удалить объект, для которого указаны финализаторы, API Kubernetes помечает объект для удаления, заполняя .metadata.deletionTimestamp, и возвращает код состояния 202 (HTTP «Принято»). Целевой объект остается в завершающем состоянии, пока плоскость управления или другие компоненты выполняют действия, определенные финализаторами. После завершения этих действий контроллер удаляет соответствующие финализаторы из целевого объекта. Если поле Metadata.finalizers пусто, Kubernetes считает удаление завершенным и удаляет объект.

Вы можете использовать финализаторы для управления сборкой мусора ресурсов. Например, вы можете определить финализатор для очистки связанных ресурсов или инфраструктуры перед тем, как контроллер удалит целевой ресурс.

Вы можете использовать финализаторы для управления сборкой мусора объектов, предупреждая контроллеры о необходимости выполнения определенных задач очистки перед удалением целевого ресурса.

Финализаторы обычно не указывают код для выполнения. Вместо этого они обычно представляют собой списки ключей определенного ресурса, похожие на аннотации. Kubernetes автоматически определяет некоторые финализаторы, но вы также можете указать свои собственные.

## Как работают финализаторы

Когда вы создаете ресурс с помощью файла манифеста, вы можете указать финализаторы в поле Metadata.finalizers. Когда вы пытаетесь удалить ресурс, сервер API, обрабатывающий запрос на удаление, замечает значения в поле финализаторов и выполняет следующее:

* Изменяет объект, добавляя поле метаданных.deletionTimestamp со временем начала удаления.
* Предотвращает удаление объекта до тех пор, пока все элементы не будут удалены из его поля метаданных.finalizers.
* Возвращает код состояния 202 (HTTP «Принято»)

Контроллер, управляющий этим финализатором, замечает обновление объекта, устанавливающее метаданные.deletionTimestamp, что указывает на то, что было запрошено удаление объекта. Затем контроллер пытается удовлетворить требования финализаторов, указанных для этого ресурса. Каждый раз, когда условие финализатора удовлетворяется, контроллер удаляет этот ключ из поля финализаторов ресурса. Когда поле финализаторов очищается, объект с установленным полем deleteTimestamp автоматически удаляется. Вы также можете использовать финализаторы, чтобы предотвратить удаление неуправляемых ресурсов.

Типичным примером финализатора является kubernetes.io/pv-protection, который предотвращает случайное удаление объектов PersistentVolume. Когда объект PersistentVolume используется подом, Kubernetes добавляет финализатор pv-protection. Если вы попытаетесь удалить PersistentVolume, он перейдет в состояние завершения, но контроллер не сможет его удалить, поскольку существует финализатор. Когда под перестает использовать PersistentVolume, Kubernetes очищает финализатор pv-защиты, а контроллер удаляет том.

{{<note>}}
* Когда вы удаляете объект, Kubernetes добавляет метку времени удаления для этого объекта, а затем сразу же начинает ограничивать изменения в поле .metadata.finalizers для объекта, который сейчас ожидает удаления. Вы можете удалить существующие финализаторы (удалив запись из списка финализаторов), но не можете добавить новый финализатор. Вы также не можете изменить значение deletionTimestamp для объекта после его установки.

* После запроса на удаление вы не сможете воскресить этот объект. Единственный способ — удалить его и создать новый аналогичный объект.
{{</note>}}

## Ссылки на владельцев, метки и финализаторы

Как и метки, [ссылки на владельца](https://kubernetes.io/docs/concepts/overview/working-with-objects/owners-dependents/) описывают отношения между объектами в Kubernetes, но используются для другой цели. Когда контроллер управляет такими объектами, как модули, он использует метки для отслеживания изменений в группах связанных объектов. Например, когда задание создает один или несколько модулей Pod, контроллер заданий применяет метки к этим модулям и отслеживает изменения во всех модулях в кластере с той же меткой.

Контроллер заданий также добавляет ссылки на владельцев этих модулей, указывая на задание, создавшее эти модули. Если вы удалите задание во время работы этих модулей, Kubernetes будет использовать ссылки на владельцев (а не метки), чтобы определить, какие модули в кластере нуждаются в очистке.

Kubernetes также обрабатывает финализаторы, когда идентифицирует ссылки на владельца ресурса, предназначенного для удаления.

В некоторых ситуациях финализаторы могут блокировать удаление зависимых объектов, в результате чего целевой объект-владелец может оставаться дольше, чем ожидалось, без полного удаления. В таких ситуациях вам следует проверить финализаторы и ссылки на владельца целевого владельца и зависимых объектов, чтобы устранить причину.

{{<note>}}
В случаях, когда объекты застревают в состоянии удаления, не удаляйте финализаторы вручную, чтобы продолжить удаление. Финализаторы обычно добавляются к ресурсам не просто так, поэтому их принудительное удаление может привести к проблемам в вашем кластере. Это следует делать только тогда, когда цель финализатора понятна и достигается другим способом (например, очисткой какого-либо зависимого объекта вручную).
{{</note>}}

## {{% heading "Что дальше" %}}

Прочтите статью [«Использование финализаторов для управления удалением»](https://kubernetes.io/blog/2021/05/14/using-finalizers-to-control-deletion/) в блоге Kubernetes.
